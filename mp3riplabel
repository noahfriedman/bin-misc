#!/usr/bin/env bash
# $Id: mp3riplabel,v 1.13 2007/07/21 18:08:03 friedman Exp $

# Requires python-eyed3 fedora rpm

file_template()
{
    file_author=`file_filter "$author"`
     file_album=`file_filter "$album"`

    for f in \
        $file_author.$file_album?$1.*.mp3 \
        track$1.*.mp3 \
        track_$1.mp3 \
        $1-*.mp3 \
        $1.*.mp3 \
        "$1 "*.mp3 \
        *" - $1 - "*.mp3 \
        *.$1.*.mp3 \
        *-$1-*.mp3 \
        *_$1_*.mp3 \
        *" $1 "*.mp3
    do
        if [ -f "$f" ]; then
            echo "$f"
            return
        fi
    done
}

file_filter()
{
    echo "$*" \
        | sed -e "s/  *$//" \
              -e "s=/=_=g"
}

eyed3()
{
    set eyeD3 --no-tagging-time-frame ${1+"$@"}
    case $VERBOSE in
        '' ) "$@" ;;
        *  ) (set -x; "$@") ;;
    esac
}

label()
{
    track=$1
    title=$2
    shift; shift

    comment=$defcomment
    comment_empty=
    case ${1+isset}:$1 in
        isset:-* | : ) : ;;
        isset:   )
            comment=
            comment_empty=t
            shift ;;
        isset:?* )
            comment=$1
            shift ;;
    esac
    case $comment_empty:$comment in
        t: | :?* )
            set fnord --comment=::"$comment" ${1+"$@"}
            shift ;;
    esac

    file=`file_template "$track"`
    touch -r "$file" .stamp

    echo ----------------------------------------
    echo "$file"
    {
        case $reset_tags in
            '' ) : ;;
            *  ) (
                    set fnord
                    for tag in $reset_tags ; do
                        case $tag in
                            TXXX:* ) set "$@" --set-user-text-frame ${tag#TXXX:}: ;;
                            *      ) set "$@" --set-text-frame $tag: ;;
                        esac
                    done
                    shift
                    eyed3 "$@" "$file"
                ) ;;
        esac

        eyed3 \
            --set-encoding utf16-LE        \
            --to-v2.3                      \
            --artist       "$author"       \
            --album        "$album"        \
            --disc         "$disc"         \
            --disc-total   "$disc_total"   \
            --track        "$track"        \
            --track-total  "$track_total"  \
            --title        "$title"        \
            --year         "$year"         \
            --genre        "$genre"        \
            ${1+"$@"} \
            "$file"
    } > /dev/null

    touch -r .stamp "$file"
    rm -f .stamp
}

discstr()
{
    discstr=
    case $disc:$disc_total in
        : | 1:1 ) : ;;
        *:  ) echo   " (disc $disc)" ;;
        *:* ) printf " (disc %0${#disc_total}d of %d)" $disc $disc_total ;;
    esac
}

rename_eyeD3()
{
    track=$1
    old=`file_template "$track"`

    fmt="%A - %a`discstr` - %n - %t"

    echo ----------------------------------------
    echo "$old"
    {
        eyed3 -v \
            --rename      "$fmt" \
            --fs-encoding "utf8" \
            "$old"
    } > /dev/null
}

rename()
{
    track=$1
    title=$2

    albumstr=$album`discstr`

    old=`file_template "$track"`
    new=`file_filter "$author - $albumstr - $track - $title.mp3"`

    case $new in
        $old ) : ;;
        *    ) mv -v "$old" "$new" ;;
    esac
}

config()
{
                ##############################
        author=''
         album=''

          year=
         genre=
    defcomment=

   track_total=

          disc=
    disc_total=

    # These are useful if you want to get rid of the track total or disc
    # total, which will not be removed if it already exists, even if the
    # explicit replacement is empty.
    reset_tags= #'TPOS TRCK'
}

doit()
{ :
           ##############################
   #$1 01 "Example Title"
}

main()
{
    config
    doit label
    doit rename
}

eyeD3 --version > /dev/null || exit $?
#main "$@"

# eof

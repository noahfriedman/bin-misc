#! /bin/sh
# $Id: p4-init-env,v 1.6 2000/05/08 19:33:07 friedman Exp $

# Commentary:

# Output proper p4 environment variable settings based on subnet.
# These should be eval'ed by the calling shell.

# Based 1999-10-15 on Ryan Hamilton's `p4set' tcsh script.

# Usage: eval `p4-init-env [user]`
#        eval `p4-init-env [-shell]`

# Code:

uid=`whoami`
user=${USER-${LOGNAME-$uid}}
hostname=${HOSTNAME-`hostname`}
hostname=`echo "$hostname" | sed 's/\..*//'`
shell=$SHELL

# Defaults which can be overridden below
case "${P4USER+set}" in
  set ) : ;;
  * )
    case "$1" in
      '' ) P4USER=$user ;;
      -* )
        P4USER=$user
        shell=`echo "x$1" | sed -e 's/^x-//'`
        shift
       ;;
      *  )
        P4USER=$1
        shift
       ;;
    esac
   ;;
esac

case "${P4CLIENT+set}" in
  set ) : ;;
  * )
    case "$hostname" in
      trabanten-schwein ) P4CLIENT=$uid.laptop    ;;
      puerco-del-diablo ) P4CLIENT=$uid.puerco    ;;
      * )                 P4CLIENT=$uid.$hostname ;;
    esac
   ;;
esac

case "${P4PORT+set}" in
  set ) : ;;
  * )
    # Determine subnet based on default route gateway
    subnet=`netstat -rn \
             | sed -n -e '/^default/b p' \
                      -e '/^0\.0\.0\.0/b p' \
                      -e d \
                      -e :p \
                      -e 's/[ 	][ 	]*/ /g' \
                      -e 's/^[^ ]* //' \
                      -e 's/ .*//' \
                      -e p -e q`

    case "$subnet" in
      192.168.1.* )       P4PORT=localhost      ;;   # prv.splode.com proxy

      62.172.199.* )      P4PORT=beryl          ;;   # uk1
      202.212.5.1 )       P4PORT=pearl          ;;   # JP1
      205.188.183.6[12] ) P4PORT=sapphire       ;;   # va3/4
      209.1.12.1 )        P4PORT=onyx           ;;   # sc1-2
      209.67.20[46].1 )   P4PORT=ruby           ;;   # va1/va2
      209.185.122.1 )     P4PORT=amber          ;;   # mini cluster
      209.185.141.1 )     P4PORT=jade           ;;   # sc3
      209.185.142.* )     P4PORT=cryolite       ;;   # congo
      209.185.143.1 )     P4PORT=j4000          ;;   # j4k
      209.131.*.1 )       P4PORT=inkdev         ;;   # intranet
      * )                 P4PORT=j4000          ;;   # default
    esac

    # Append default tcp port if missing.
    case "$P4PORT" in
      *:* ) : ;;
      * ) P4PORT=$P4PORT:1666 ;;
    esac
   ;;
esac

# Emit the right syntax based on login shell.
case "$shell" in
  *[/-]* )
    shell=`echo "$shell" \
            | sed -e '/\//s=.*/==' \
                  -e '/-/s/-[^-]*$//'`
   ;;
esac

case "$shell" in
  csh | tcsh | zsh )
    echo "setenv P4PORT   $P4PORT;"
    echo "setenv P4USER   $P4USER;"
    echo "setenv P4CLIENT $P4CLIENT;"
   ;;
  emacs | scsh )
    progn="progn"
    case "$shell" in scsh ) progn="begin" ;; esac
    echo "($progn"
    echo "  (setenv \"P4PORT\"   \"$P4PORT\")"
    echo "  (setenv \"P4USER\"   \"$P4USER\")"
    echo "  (setenv \"P4CLIENT\" \"$P4CLIENT\"))"
   ;;
  * )
    echo "P4PORT=$P4PORT;"
    echo "P4USER=$P4USER;"
    echo "P4CLIENT=$P4CLIENT;"
    case "$shell" in
      es | rc ) : ;;
      * )
        echo "export P4PORT P4USER P4CLIENT;"
       ;;
    esac
  ;;
esac

# p4-init-env ends here.
